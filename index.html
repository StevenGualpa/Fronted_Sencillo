<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clasificador de Im√°genes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Clasificador de Im√°genes con AWS Lambda</h4>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="imagen" class="form-label">Selecciona una imagen:</label>
          <input class="form-control" type="file" id="imagen" accept="image/*">
        </div>
        <button class="btn btn-success" onclick="clasificarImagen()">Subir y Clasificar</button>

        <div id="resultado" class="mt-4" style="display: none;">
          <h5>Resultado:</h5>
          <p><strong>Tipo Detectado:</strong> <span id="tipo"></span></p>
          <p><strong>Descripci√≥n:</strong> <span id="descripcion"></span></p>
          <p><strong>Respuesta del Backend:</strong></p>
          <pre id="respuesta" class="bg-light p-2 border rounded"></pre>
        </div>

        <hr>
        <div id="listado" class="mt-4">
          <h5>Listado de Im√°genes Guardadas:</h5>
          <ul id="imagenesList" class="list-group"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function clasificarImagen() {
      const input = document.getElementById('imagen');
      const file = input.files[0];
      if (!file) return alert("Por favor selecciona una imagen");

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64 = reader.result.split(",")[1];

        const payload = {
          fileName: file.name,
          image: base64
        };

        try {
          const res = await fetch("https://i2ux3umjlk4z2uxhfyfmucmsii0zebqe.lambda-url.us-east-2.on.aws/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          document.getElementById("resultado").style.display = "block";
          document.getElementById("tipo").innerText = data.classification?.typeDetected || 'Desconocido';
          document.getElementById("descripcion").innerText = data.classification?.description || 'No se pudo clasificar';
          document.getElementById("respuesta").innerText = JSON.stringify(data.backendResponse || data, null, 2);

          // Recargar listado de im√°genes
          obtenerImagenes();
        } catch (error) {
          alert("Error al clasificar la imagen: " + error);
        }
      };
      reader.readAsDataURL(file);
    }
    async function obtenerImagenes() {
  try {
    const res = await fetch("http://107.23.71.140:8080/imagenes");
    const data = await res.json();

    console.log("‚úÖ Datos recibidos:", data); // üëâ A√ëADIDO PARA VERIFICAR

    const lista = document.getElementById("imagenesList");
    lista.innerHTML = "";

    data.forEach(img => {
      const tipo = img.tipo_detectado || 'Sin clasificar';
      const descripcion = img.descripcion?.trim() || 'Sin descripci√≥n';
      const archivo = img.archivo || '';
      const urlImagen = archivo ? `http://107.23.71.140:8080/${archivo}` : '';

      const item = document.createElement("li");
      item.className = "list-group-item";

      let contenido = `<div class="d-flex align-items-center">`;
      if (archivo && archivo.endsWith('.jpg')) {
        contenido += `<img src="${urlImagen}" alt="imagen" width="100" class="me-3 border rounded" onerror="this.style.display='none'">`;
      }
      contenido += `<div>
          <p class="mb-1"><strong>${img.nombre}</strong></p>
          <p class="mb-0">${tipo} - ${descripcion}</p>
        </div>
      </div>`;

      item.innerHTML = contenido;
      lista.appendChild(item);
    });

  } catch (error) {
    console.error("‚ùå No se pudo cargar el listado de im√°genes", error);
  }
}


    // Cargar listado al iniciar
    obtenerImagenes();
  </script>
</body>
</html>
